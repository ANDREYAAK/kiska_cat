# Настройка локального PostgreSQL

## Быстрый старт

### 1. Установить зависимости сервера

```bash
cd server
npm install
```

### 2. Создать базу данных

```bash
# Подключиться к PostgreSQL
psql -U postgres

# Создать базу данных
CREATE DATABASE game_db;

# Выйти
\q
```

### 3. Инициализировать таблицы

```bash
psql -U postgres -d game_db -f server/init.sql
```

### 4. Настроить переменные окружения

Создайте файл `server/.env`:

```env
PORT=3001
DB_HOST=localhost
DB_PORT=5432
DB_NAME=game_db
DB_USER=postgres
DB_PASSWORD=postgres
```

### 5. Запустить сервер

```bash
cd server
npm start
```

Сервер будет доступен на `http://localhost:3001`

### 6. Настроить игру

Создайте файл `.env` в корне проекта:

```env
VITE_API_URL=http://localhost:3001
```

Перезапустите dev-сервер игры.

## Проверка работы

1. Откройте игру в браузере
2. Перетащите объект на карте
3. Через 2 секунды должно произойти автосохранение
4. Перезагрузите страницу - объекты должны остаться на месте!

## Архитектура

### Автосохранение
- **Debounce 2 секунды** - сохраняет через 2 сек после последнего изменения
- **Batch updates** - все изменения сохраняются разом
- **Оптимистичные обновления** - UI обновляется сразу, сохранение в фоне

### Хранение данных
- **Локально (IndexedDB)** - для быстрого доступа
- **На сервере (PostgreSQL)** - для синхронизации и защиты от потери

### Производительность
- Минимум запросов к БД (только при изменениях)
- JSONB в PostgreSQL для эффективного хранения
- Индексы для быстрого поиска

## Структура БД

```
users
├── id (SERIAL)
├── email (VARCHAR, UNIQUE)
├── password_hash (VARCHAR)
└── username (VARCHAR)

saves
├── id (SERIAL)
├── user_id (INTEGER, FK -> users.id)
├── slot_id (VARCHAR) - "autosave", "slot_1", etc.
├── data (JSONB) - все данные сохранения
└── updated_at (TIMESTAMP)
```

## Для продакшена

1. Используйте `bcrypt` для хеширования паролей
2. Добавьте JWT токены для авторизации
3. Настройте HTTPS
4. Добавьте rate limiting
5. Настройте резервное копирование БД
